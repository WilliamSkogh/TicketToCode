@page "/tickets"
@using TicketToCode.Core.Models
@using Microsoft.AspNetCore.Components.Forms
@inject HttpClient Http
@inject NavigationManager Navigation

<h1>Boka biljett till ett event</h1>

@if (_successMessage != null)
{
    <p style="color: green;">@_successMessage</p>
}
@if (_errorMessage != null)
{
    <p style="color: red;">@_errorMessage</p>
}

<EditForm Model="@ticket" OnValidSubmit="BuyTicket">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div>
        <label>Förnamn:</label><br />
        <InputText @bind-Value="@ticket.FirstName" /><br /><br />
    </div>
    <div>
        <label>Efternamn:</label><br />
        <InputText @bind-Value="@ticket.LastName" /><br /><br />
    </div>
    <div>
        <label>Telefon:</label><br />
        <InputText @bind-Value="@ticket.Phone" /><br /><br />
    </div>
    <div>
        <label>Email:</label><br />
        <InputText @bind-Value="@ticket.Email" /><br /><br />
    </div>

    <div>
        <label>Event:</label><br />
        @if (events == null || events.Count == 0)
        {
            <p>Laddar events...</p> 
        }
        else
        {
            <InputSelect @bind-Value="@ticket.EventId" required>
                <option value="">Välj ett event</option>
                @foreach (var evt in events)
                {
                    <option value="@evt.Id">@evt.Name</option>
                }
            </InputSelect><br /><br />
        }
    </div>

    <div>
        <label>Antal biljetter:</label><br />
        <InputNumber @bind-Value="@ticket.Quantity" /><br /><br />
    </div>
    <div>
        <label>Betalmetod:</label><br />
        <InputSelect @bind-Value="@ticket.PaymentMethod">
            <option value="">Välj betalmetod</option>
            @foreach (var method in Enum.GetValues<PaymentMethod>())
            {
                <option value="@method">@method</option>
            }
        </InputSelect><br /><br />
    </div>

    <button type="submit">Boka</button>
</EditForm>

@code {
    private Ticket ticket = new();
    private List<EventModel> events = new();

    private string? _successMessage;
    private string? _errorMessage;

    private class EventModel
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var response = await Http.GetAsync("https://localhost:5235/events");
            if (response.IsSuccessStatusCode)
            {
                events = await response.Content.ReadFromJsonAsync<List<EventModel>>() ?? new();
            }
            else
            {
                _errorMessage = "Kunde inte hämta event.";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Fel vid hämtning av event: {ex.Message}";
        }
    }

    private async Task BuyTicket()
    {
        try
        {
            var response = await Http.PostAsJsonAsync("https://localhost:5235/tickets", ticket);
            if (response.IsSuccessStatusCode)
            {
                _successMessage = "Bokningen lyckades!";
                _errorMessage = null;
                ticket = new(); 
            }
            else
            {
                _errorMessage = "Kunde inte boka biljett.";
                _successMessage = null;
            }
        }
        catch
        {
            _errorMessage = "Något gick fel vid bokningen.";
            _successMessage = null;
        }
    }
}
